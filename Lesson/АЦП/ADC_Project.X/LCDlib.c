#include "LCDlib.h"
#include    <stdint.h>
//-------------------------------------------------------------------------
//	??????? ??????? ? ?????? ????????? ?? ?????
//	?????????? ????????:
//			char data
//			???????? ????????? ??????
//-------------------------------------------------------------------------
void lcd_out(char data)
{
    if(data&0x01)
    {
        D4=1;
        
    }
    else
    {
        D4=0;
    }
    
    if(data&0x02)
    {
        D5=1;
        
    }
    else
    {
        D5=0;
    }
    
    if(data&0x04)
    {
        D6=1;
        
    }
    else
    {
        D6=0;
    }
    
    if(data&0x08)
    {
        D7=1;
        
    }
    else
    {
        D7=0;
    }
}


//-------------------------------------------------------------------------
//	??????? ???????? ??????? ? ???????
//	?????????? ????????:
//			char com
//			???????
//-------------------------------------------------------------------------
void lcd_com(char com)
{
	RS_COM();				// ????? ???????
	lcd_out(com);			// ????? ?????? ?? ????
	E_SET();				// ????????? ?
	E_RESET();				// ???????? ?
	__delay_ms(4);			// ????? ??????? ?????
}


//-------------------------------------------------------------------------
//	??????? ????????????? ???????
//	?????????? ?????????:
//			char lcd
//			0 - ??????? ????? ??????? ????, ?????? ?? ?????????
//			1 - ??????? ????? ??????? ????, ?????? ?????? ? ???? ????? ???????
//			2 - ??????? ????? ??????? ????, ?????? ? ???? ?????????????
//			3 - ??????? ????? ??????? ????, ?????? ? ???? ????????????? ? ?????? ??????
//-------------------------------------------------------------------------

void lcd_init(char lcd)
{
	DDR_COMAND=0x00;
    DDR_DATA=0x00;
    
	switch (lcd)
	{
		case 0: lcd = 0x0C; break;
		case 1: lcd = 0x0D; break;
		case 2: lcd = 0x0E; break;
		case 3: lcd = 0x0F; break;
	}

	__delay_ms(20);		// ????? ????????? ??????? ????????? 20 ??
	
	lcd_com(0x03);		// ??????? ? 4-? ?????? ?????
	__delay_us(40);
	lcd_com(0x03);		// ??????? ? 4-? ?????? ?????
	__delay_us(40);
	lcd_com(0x03);		// ??????? ? 4-? ?????? ?????
	__delay_us(40);
	lcd_com(0x02);		// ??????? ? 4-? ?????? ?????
	__delay_us(40);
	lcd_com(0x02);		// ????????? ??????????
	lcd_com(0x08);		// ????????? ??????????
	lcd_com(0x00);		// ????????? ???????
	lcd_com(0x08);		// ????????? ???????
	lcd_com(0x00);		// ??????? ???????
	lcd_com(0x01);		// ??????? ???????
	lcd_com(0x00);		// ????????????? ????? ????? ??????
	lcd_com(0x06);		// ????????????? ????? ????? ??????
	lcd_com(0x00);		// ???????? ??????? ? ????????? ????????
	lcd_com(lcd);		// ???????? ??????? ? ????????? ????????
}

//-------------------------------------------------------------------------
//	??????? ???????? ????? ?????? ???????
//	??????????? ????????:
//			char data
//			???????????? ????
//-------------------------------------------------------------------------
void lcd_char_out(char data)
{
	RS_DATA();							// ???????? ??????
	lcd_out(data >> 4);					// ???????? ??????? 4 ???
	E_SET();
	E_RESET();
	lcd_out(data & 0x0F);				// ???????? ??????? 4 ???
	E_SET();
	E_RESET();
	__delay_ms(4);						// ????? ????????? ?????
}

//-------------------------------------------------------------------------
//	??????? ?????? ??????
//	??????????? ????????:
//			char *str
//			????????? ?? ?????? ??????????????? ??????? ????????.
//-------------------------------------------------------------------------
void lcd_printString(char *str)
{
	while((*str) != '\0')
	{
		lcd_char_out(*str);
		str++;
	}
}


//-------------------------------------------------------------------------
//	??????? ????????? ?????? ?? ???? X, Y
//	?????????? ?????????:
//			char x, char y
//			? - ???????? ?? 0 ?? 39. ?????? ??????
//			y - ???????? ?? 0 ?? 3.  ????? ??????
//-------------------------------------------------------------------------
void lcd_gotoxy(char x, char y)
{
	if(x > 39) x = 39;
	if(x < 0) x = 0;
	if(y > 3) y = 3;
	if(y < 0) y = 0;
	
	char temp = 0x00;

	RS_COM();
	
	switch (y)
	{
		case 0:
		{
			temp |= (0x80 + x);
			lcd_com(temp >> 4);			// ???????? ??????? 4 ???
			lcd_com(temp & 0x0F);		// ???????? ??????? 4 ???
			break;
		}
		case 1:
		{
			temp |= (0xC0 + x);
			lcd_com(temp >> 4);			// ???????? ??????? 4 ???
			lcd_com(temp & 0x0F);		// ???????? ??????? 4 ???
			break;
		}
		case 2:
		{
			temp |= (0x94 + x);
			lcd_com(temp >> 4);			// ???????? ??????? 4 ???
			lcd_com(temp & 0x0F);		// ???????? ??????? 4 ???
			break;
		}
		case 3:
		{
			temp |= (0xD4 + x);
			lcd_com(temp >> 4);			// ???????? ??????? 4 ???
			lcd_com(temp & 0x0F);		// ???????? ??????? 4 ???
			break;
		}
	}

}

void lcd_printStringXY(char *str,char x,char y)
{
	lcd_gotoxy(x,y);
	lcd_printString(str);
}



//-------------------------------------------------------------------------
//	??????? ??????? ??????? ? ????????? ??????? ?? 0 ??????, 0 ??????
//-------------------------------------------------------------------------
void lcd_clear(void)
{
	lcd_com(0x00);
	lcd_com(0x01);
}


//-------------------------------------------------------------------------
//	??????? ???????? ? ?????? ? ?????? ?????? ???????
//	???????????? ?????????:
//		char simbol - ????? ? CGRAM ?? 0 ?? 15
//		char *str - ????????? ?? ?????? ??????? ? ??????? ???????
//-------------------------------------------------------------------------
void lcd_simbol(char simbol, char *str)
{
	simbol = (8 * simbol) | 0x40;
	lcd_com(simbol >> 4);
	lcd_com(simbol & 0x0F);
	for(char i = 0; i <= 7; i++)
	{
		lcd_char_out(*str);
		str++;
	}
	
	lcd_gotoxy(0,0);

}
